<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>gogpweb</title>
<link rel="stylesheet" href="main.css"/>
<link rel="stylesheet" href="jquery-ui.custom.css"/>
<script type="text/javascript" src="jquery.min.js"></script>
<script type="text/javascript" src="jquery-ui.custom.min.js"></script>
<script type="text/javascript" src="jquery.flot.js"></script>
<script type="text/javascript" src="jquery.flot.JUMlib.js"></script>
<script type="text/javascript" src="jquery.flot.bubbles.js"></script>
<script type="text/javascript">
$(function() {
    var first = true;
    var done = false;
    var running = false;
    var generation = 0;
    var maxGen = 0;
    var wait = 500;
    var options = {
        legend: { position: "se" },
        xaxis:  { },
        yaxis:  { autoscaleMargin: null },
        colors: [ "#ff0000", "#0000ff", "#b0b0ff" ],
        series: { bubbles: { active:true, show:false} }
    };

    // set stats headers
    function setHeaders(headers) {
        var html = "";
        for (var i = 0; i < headers.length; i++) {
             var cls = (i==headers.length-1) ? ' class="rightHeader"' : "";
             html += "<th"+cls+">" + headers[i] + "</th>";
        }
        $("#stats-head").append("<tr>" + html + "</tr>");
    }

    // append stats to table
    function updateStats(stats) {
        for (var i = 0; i < stats.length; i += 1) {
            var row = stats[i];
            var cls = (parseInt(row[0]) % 2 == 0) ? '"reg"' : '"alt"';
            var html = "<tr class="+cls+"><td>"+row.join("</td><td>")+"</td></tr>";
            $("#stats-grid").prepend(html);
        }
    }

    // get data and update the given plot
    function fetchPlot(id, field) {
        $.getJSON("/plot/" + field,
            function(data) {
                options.xaxis.min = (field != "Plot") ? 0 : null;
                options.xaxis.max = (field != "Plot") ? maxGen : null;
                options.yaxis.min = options.xaxis.min; 
                options.yaxis.max = (field == "Fit") ? 1 : null;
                options.series.bubbles.show = data[0].lines.bubbles.show;
                $.plot($(id), data, options);
            }
        );
    }

    // get the stats and plot data until got generation no. gen
    function fetch(gen) {
        $.getJSON("/stats/" + generation,
            function(data) { 
                if (first) {
                    setHeaders(data.Headers);
                    first = false;
                }
                updateStats(data.Stats);
                $("#best").html(data.Best);
                generation = data.Gen + 1;
                maxGen = data.MaxGen;
                if (data.Done) { done = true; }
                if (generation < gen && !done) {
                    setTimeout(function() { fetch(gen) }, wait);
                } else {
                    fetchPlot("#plot1", $("#choose-plot1").val());
                    fetchPlot("#plot2", $("#choose-plot2").val());
                }
            }
        );
    }

    // step to next generation
    function step() {
        if (done) { return; }
        $.getJSON("/step",
            function(isDone) {
                if (isDone) {
                    fetch(generation);
                    done = true;
                    running = false;
                    $("#doRun").text("run");
                } else {
                    fetch(generation+1);
                    if (running) { setTimeout(step, wait); }
                }
            }
        );
    }

    // slider to control animation speed
    function updateSlider(value) {
        wait = value;
        $("#wait").text("delay: " + value + " msec");
    }
    $("#slider").slider({
        min: 0,
        max: wait*2,
        step: 50,
        value: wait,
        slide: function(event, ui) { updateSlider(ui.value); }
    });
    updateSlider(wait);

    // single step
    $("#doStep").click(step);

    // step every wait msec
    $("#doRun").click(function() {
        running = !running;
        if (running) {
            $("#doRun").text("stop");
            step();
        } else {
            $("#doRun").text("run");
        }
    });

    // get next run
    $("#doRestart").click(function() {
        done = false;
        generation = 0;
        $("#best").html("");
        $("#stats-grid").find("tr").remove();
        $.getJSON("/start", step );
    });

    // update data if selected new plot type
    $("#choose-plot1").change(function() {
        fetchPlot("#plot1", $("#choose-plot1").val());
    });
    $("#choose-plot2").change(function() {
        fetchPlot("#plot2", $("#choose-plot2").val());
    });

    // update data on load
    fetch(1);
});
</script>
</head>
<body>
<div class="menu-container">
<table>
<tr>
  <td class="button-cell"><button id="doStep">step</button></td>
  <td class="button-cell"><button id="doRun">run</button></td>
  <td class="button-cell"><button id="doRestart">restart</button></td>
  <td class="chooser-cell">plot 1:
    <select id="choose-plot1">
        <option value="Fit" selected>fitness</option>
        <option value="Size">size</option>
        <option value="Depth">depth</option>
        <option value="Plot">custom</option>
    </select>
  </td>
  <td class="chooser-cell">plot 2:
    <select id="choose-plot2">
        <option value="Fit">fitness</option>
        <option value="Size" selected>size</option>
        <option value="Depth">depth</option>
        <option value="Plot">custom</option>
    </select>
  </td>
  <td class="slider-cell">
    <div id="slider"></div>
    <div id="wait"></div>
  </td>
</tr>
</table>
</div>

<div id="plot1" class="plot1-container"></div>
<div id="plot2" class="plot2-container"></div>

<div class="best-container">
  <div id="best" class="best-box"></div>
</div>

<div class="stats-container">
  <div class="tableContainer">
  <table border="0" cellpadding="0" cellspacing="0" width="100%">
    <thead class="fixedHeader" id="stats-head">
    </thead>
    <tbody class="scrollContent" id="stats-grid">
    </tbody>
  </table>
  </div>
</div>

</body>
</html>
