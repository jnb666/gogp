<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>gogpweb</title>
<link rel="stylesheet" href="main.css"/>
<link rel="stylesheet" href="jquery-ui.custom.css"/>
<script type="text/javascript" src="jquery.min.js"></script>
<script type="text/javascript" src="jquery-ui.custom.min.js"></script>
<script type="text/javascript" src="jquery.flot.js"></script>
<script type="text/javascript">
$(function() {
    var first = true;
    var done = false;
    var running = false;
    var generation = 0;
    var wait = 500;
    var options = {
        legend: { position: "nw" },
        xaxis:  { },
        yaxis:  { },
        colors: [ "#ff0000", "#0000ff", "#b0b0ff" ]
    };

    // set stats headers
    function setHeaders(headers) {
        var html = "";
        for (var i = 0; i < headers.length; i++) {
             var cls = (i==headers.length-1) ? ' class="rightHeader"' : "";
             html += "<th"+cls+">" + headers[i] + "</th>";
        }
        $("#stats-head").append("<tr>" + html + "</tr>");
    }

    // process new data
    function doUpdate(data, field) {
        // update the stats
        for (var i = 0; i < data.Stats.length; i += 1) {
            var row = data.Stats[i];
            var cls = (parseInt(row[0]) % 2 == 0) ? '"reg"' : '"alt"';
            var html = "<tr class="+cls+"><td>"+row.join("</td><td>")+"</td></tr>";
            $("#stats-grid").prepend(html);
        }
        // update best individual
        $("#best").html(data.Best);
        // update the plot
        options.xaxis.min = (field != "Plot") ? 0 : null;
        options.xaxis.max = (data.MaxGen > 0 && field != "Plot") ? data.MaxGen : null;
        options.yaxis.min = options.xaxis.min; 
        options.yaxis.max = (field == "Fit") ? 1 : null;
        $.plot($("#placeholder"), data.Plots, options);
    }

    // get the stats and plot data until got generation no. gen
    function fetch(gen) {
        var field = $("input[name=dataset]:checked", "#choose").val();
        $.getJSON("/data/" + field + "/" + generation,
            function(data) { 
                // process AJAX response
                if (first) {
                    setHeaders(data.Headers);
                    first = false;
                }
                if (data.Plots.length > 0) {
                    doUpdate(data, field);
                    generation = data.Gen + 1;
                }
                if (data.Done) { done = true; }
                if (generation < gen && !done) {
                    setTimeout(function() { fetch(gen) }, wait)
                }
            }
        );
    }

    // step to next generation
    function step() {
        if (done) { return; }
        $.getJSON("/step",
            function(isDone) {
                if (isDone) {
                    fetch(generation);
                    done = true;
                    running = false;
                    $("#doRun").text("run");
                } else {
                    fetch(generation+1);
                    if (running) { setTimeout(step, wait); }
                }
            }
        );
    }

    // slider to control animation speed
    function updateSlider(value) {
        wait = value;
        $("#wait").text("delay: " + value + " msec");
    }
    $("#slider").slider({
        min: 0,
        max: wait*2,
        step: 50,
        value: wait,
        slide: function(event, ui) { updateSlider(ui.value); }
    });
    updateSlider(wait);

    // single step
    $("#doStep").click(step);

    // step every wait msec
    $("#doRun").click(function() {
        running = !running;
        if (running) {
            $("#doRun").text("stop");
            step();
        } else {
            $("#doRun").text("run");
        }
    });

    // get next run
    $("#doRestart").click(function() {
        done = false;
        generation = 0;
        $("#best").html("");
        $("#stats-grid").find("tr").remove();
        $.getJSON("/start",
            function(ok) {
                if (ok) { fetch(1); }
            }
        );
    });

    // update data if selected new plot type
    $("#choose input").on("change", function() { fetch(0) });

    // update data on load
    fetch(1);
});
</script>
</head>
<body>
<div id="placeholder" class="plot-container"></div>
<div class="form-container">
  <button id="doStep">step</button> &nbsp;
  <button id="doRun">run</button> &nbsp;
  <button id="doRestart">restart</button>
  <br><br>
  <div id="slider"></div>
  <div id="wait"></div>
  <br>
  <form id="choose">
    <input type="radio" name="dataset" value="Fit" checked> fitness<br>
    <input type="radio" name="dataset" value="Size"> size<br>
    <input type="radio" name="dataset" value="Depth"> depth<br>
    <input type="radio" name="dataset" value="Plot"> custom<br>
  </form>
</div>
<div class="best-container">
  <div id="best" class="best-box"></div>
</div>
<div class="stats-container">
  <div id="tableContainer" class="tableContainer">
  <table border="0" cellpadding="0" cellspacing="0" width="100%" class="scrollTable">
    <thead class="fixedHeader" id="stats-head">
    </thead>
    <tbody class="scrollContent" id="stats-grid">
    </tbody>
  </table>
  </div>
</div>
</body>
</html>
